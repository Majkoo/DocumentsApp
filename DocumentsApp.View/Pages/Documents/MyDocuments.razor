@page "/documents"

@using DocumentsApp.Shared.Dtos.DocumentDtos
@using Sieve.Models
@using DocumentsApp.Data.Exceptions
@using DocumentsApp.Shared.Notifications

@inject IJSRuntime JsRuntime
@inject IDocumentService DocumentService
@inject NotificationService NotificationService

@attribute [Authorize]

<PageTitle>DocumentsApp - My Documents</PageTitle>

<div class="row p-3 pb-5 mb-5">

    <div class="p-2 col-6 col-lg-3 col-xl-2">
        <AddNewDocumentCard OnDocumentCreated="OnDocumentCreated"/>
    </div>

        @foreach (var doc in _documentDtos)
        {
            <div class="p-2 col-6 col-lg-3 col-xl-2">
                <DocumentCard Document="@doc" />
            </div>
        }

        <div class="fixed-bottom border-top bg-white pagin-footer">
            <RadzenPager
                HorizontalAlign="HorizontalAlign.Right"
                Count="@ItemCount"
                PageSize="@PageSize"
                PageNumbersCount="@((int)Math.Ceiling((decimal)ItemCount/PageSize))"
                PageChanged="@FetchItems" />

        </div>


</div>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private List<GetDocumentDto> _documentDtos = new List<GetDocumentDto>();
    private int Page { get; set; } = 1;
    private int PageSize { get; set; } = 11;
    private int ItemCount { get; set; } = 1;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await GetDocs(1);
        }
        catch (NotFoundException)
        {
            NotificationService.Notify(
                new InfoNotification("You have no documents yet.","Click \"add a new document\" to create your first document!")
                );
        }
    }

    private async Task FetchItems(PagerEventArgs args)
    {
        await GetDocs(args.PageIndex + 1);
    }

    private async Task GetDocs(int pageIndex)
    {
        await JsRuntime.InvokeVoidAsync("OnScrollEvent");
        var sieveModel = new SieveModel()
        {
            Page = pageIndex,
            PageSize = PageSize,
        };

        var pagedResults = await DocumentService.GetAllDocumentsAsync(sieveModel);
        Page = pageIndex;
        ItemCount = pagedResults.TotalItemsCount;
        _documentDtos = pagedResults.Items;
    }

    private async Task OnDocumentCreated(GetDocumentDto dto)
    {
        if (Page == 1)
        {
            _documentDtos.Insert(0, dto);
            if (_documentDtos.Count == PageSize)
            {
                _documentDtos.RemoveAt(_documentDtos.Count - 1);
            }
        }
    }

}