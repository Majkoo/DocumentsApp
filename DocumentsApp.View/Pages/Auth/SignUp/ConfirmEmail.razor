@page "/auth/confirmemail"
@using Microsoft.AspNetCore.Identity
@using DocumentsApp.Shared.Notifications
@using System.Text
@using DocumentsApp.Data.Entities

@inject IAccountService AccountService
@inject UserManager<Account> UserManager
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager

<div class="w-100 text-center d-flex justify-content-center align-items-center my-4">
    <div class="w-100">
        <RadzenButton Click="Confirm" ButtonStyle="ButtonStyle.Primary" Text="Confirm your email"></RadzenButton>
    </div>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = nameof(Token))]
    public string? Token { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = nameof(Email))]
    public string? Email { get; set; }

    private async Task Confirm()
    {
        var result = await AccountService.ConfirmEmailAsync(Token, Email);
        
        if (result.Succeeded)
        {
            NotificationService.Notify(new SuccessNotification("Success", "Successfully confirmed your email"));
            NavigationManager.NavigateTo("/auth/signin");
        }
        else
        {
            var sb = new StringBuilder();

            foreach (var identityError in result.Errors)
            {
                sb.Append($"{identityError.Description}\n");
            }
            NotificationService.Notify(new ErrorNotification("Could not confirm email", sb.ToString()));
        }
    }
}